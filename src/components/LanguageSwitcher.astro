---
import { LANGUAGE_OPTIONS, DEFAULT_LANG, type Lang } from '../i18n';

interface Props {
  currentLang?: Lang;
}

const { currentLang } = Astro.props as Props;
const current = currentLang ?? (Astro.params.lang as Lang | undefined) ?? DEFAULT_LANG;
const options = LANGUAGE_OPTIONS;
const emojiFontStack = `'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Twemoji Mozilla', 'EmojiOne Color', 'Android Emoji', sans-serif`;
const selectId = `lang-switcher-${Math.random().toString(36).slice(2)}`;
---
<label class="sr-only" for={selectId}>Idioma</label>
<div class="relative">
  <select
    id={selectId}
    data-lang-switcher
    class="appearance-none rounded-md bg-white/5 border border-white/10 px-2 pr-10 py-2 text-sm font-emoji"
    value={current}
  >
    {options.map(({ code, label }) => (
      <option value={code} selected={code === current} style={`font-family: ${emojiFontStack};`}>
        {label}
      </option>
    ))}
  </select>
  <span
    aria-hidden="true"
    class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-white/60"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 20 20"
      fill="currentColor"
      class="h-4 w-4"
    >
      <path
        fill-rule="evenodd"
        d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.25a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08z"
        clip-rule="evenodd"
      />
    </svg>
  </span>
</div>
<script is:inline>
  const select = document.querySelector('[data-lang-switcher]');
  const COOKIE_NAME = 'lang';
  const ONE_YEAR_SECONDS = 60 * 60 * 24 * 365;
  const setLangCookie = (value) => {
    document.cookie = `${COOKIE_NAME}=${value}; Max-Age=${ONE_YEAR_SECONDS}; Path=/; SameSite=Lax`;
  };
  if (select instanceof HTMLSelectElement) {
    const supportedLangs = Array.from(select.options).map((option) => option.value);
    const isSupportedLang = (value) => supportedLangs.includes(value);
    const htmlLang = document.documentElement.lang;
    if (isSupportedLang(htmlLang)) {
      select.value = htmlLang;
    }
    setLangCookie(select.value);

    select.addEventListener('change', () => {
      const selected = select.value;
      setLangCookie(selected);

      const { location } = window;
      const { pathname, search, hash } = location;
      const segments = pathname.split('/').filter(Boolean);
      const hasTrailingSlash = pathname.endsWith('/');

      let nextSegments;
      if (segments.length === 0) {
        nextSegments = [selected];
      } else if (isSupportedLang(segments[0])) {
        nextSegments = [selected, ...segments.slice(1)];
      } else {
        nextSegments = [selected, ...segments];
      }

      const suffix = hasTrailingSlash ? '/' : '';
      const nextPath = `/${nextSegments.join('/')}${suffix}`;

      location.assign(`${nextPath}${search}${hash}`);
    });
  }
</script>